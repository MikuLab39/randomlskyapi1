import requests
import json
import os

# 1. 配置信息从 GitHub Secrets 读取
# 兰空图床相册接口地址
LSKY_API = "https://image.mikulab.com/api/v1/images?album_id=5"
LSKY_TOKEN = os.getenv("LSKY_TOKEN")

# Cloudflare 配置
CF_ACCOUNT_ID = os.getenv("CF_ACCOUNT_ID")
CF_KV_ID = os.getenv("CF_KV_ID")
CF_API_TOKEN = os.getenv("CF_API_TOKEN")

def sync():
    # 2. 从图床获取数据
    print("正在从兰空图床拉取图片列表...")
    headers = {"Authorization": LSKY_TOKEN, "Accept": "application/json"}
    response = requests.get(LSKY_API, headers=headers)
    res = response.json()
    
    if res.get('status'):
        # 提取所有图片的 URL 链接
        urls = [img['links']['url'] for img in res['data']['data']]
        print(f"获取成功，共计 {len(urls)} 张图片。")
        
        # 3. 将列表推送到 Cloudflare KV
        # 定义 KV 存储的 Key 为 "images"
        kv_endpoint = f"https://api.cloudflare.com/client/v4/accounts/{CF_ACCOUNT_ID}/storage/kv/namespaces/{CF_KV_ID}/values/images"
        
        kv_headers = {
            "Authorization": f"Bearer {CF_API_TOKEN}",
            "Content-Type": "text/plain"
        }
        
        # 将 Python 列表转为 JSON 字符串并发送
        put_res = requests.put(kv_endpoint, headers=kv_headers, data=json.dumps(urls))
        
        if put_res.status_code == 200:
            print("Cloudflare KV 缓存更新成功！")
        else:
            print(f"同步失败，错误代码: {put_res.status_code}, 详情: {put_res.text}")
    else:
        print("图床接口请求失败，请检查 LSKY_TOKEN 是否过期。")

if __name__ == "__main__":
    sync()
